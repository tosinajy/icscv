{% extends 'base.html' %}

{% block title %}{{ carrier.legal_name }} NAIC {{ carrier.naic_code }} | CarrierCodeVerify{% endblock %}

{% block content %}
<div class="container my-5">
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
          </div>
        {% endfor %}
      {% endif %}
    {% endwith %}

    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="fw-bold mb-0">{{ carrier.legal_name }}</h1>
            <span class="badge bg-primary">{{ carrier.state_domicile }}</span>
        </div>
        <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#editModal">
            <i class="fa-solid fa-pen-to-square me-2"></i>Suggest Edit
        </button>
    </div>

    <!-- Details Cards -->
    <div class="row g-4">
        <!-- Identifiers -->
        <div class="col-lg-4">
            <div class="card h-100 shadow-sm">
                <div class="card-header bg-light fw-bold">Identifiers</div>
                <ul class="list-group list-group-flush">
                    <li class="list-group-item d-flex justify-content-between">
                        <span class="text-muted">NAIC</span>
                        <span class="fw-bold">{{ carrier.naic_code }}</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between">
                        <span class="text-muted">Payer ID</span>
                        <span class="fw-bold">{{ carrier.payer_id or 'N/A' }}</span>
                    </li>
                </ul>
            </div>
        </div>
        <!-- Contact -->
        <div class="col-lg-4">
            <div class="card h-100 shadow-sm">
                <div class="card-header bg-light fw-bold">Contact</div>
                <ul class="list-group list-group-flush">
                    <li class="list-group-item">
                        <small class="text-muted d-block">Claims Phone</small>
                        <span class="fw-bold">{{ carrier.phone_claims or 'N/A' }}</span>
                    </li>
                    <li class="list-group-item">
                        <small class="text-muted d-block">Website</small>
                        <a href="{{ carrier.website_url }}" target="_blank">{{ carrier.website_url or 'N/A' }}</a>
                    </li>
                </ul>
            </div>
        </div>
        <!-- Address -->
        <div class="col-lg-4">
            <div class="card h-100 shadow-sm">
                <div class="card-header bg-light fw-bold">Address</div>
                <div class="card-body">
                    {% if carrier.address_claims_street %}
                        {{ carrier.address_claims_street }}<br>
                        {{ carrier.address_claims_city }}, {{ carrier.address_claims_state }} {{ carrier.address_claims_zip }}
                    {% else %}
                        <span class="text-muted">No address on file.</span>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Audit History -->
    {% if history %}
    <div class="mt-4">
        <h5>Recent Updates</h5>
        <ul class="list-group">
            {% for log in history %}
            <li class="list-group-item small">
                <span class="fw-bold">{{ log.description }}</span>
                <span class="text-muted ms-2">- {{ log.changed_at }} ({{ log.changed_by }})</span>
            </li>
            {% endfor %}
        </ul>
    </div>
    {% endif %}

</div>

<!-- Edit Modal -->
<div class="modal fade" id="editModal" tabindex="-1">
    <div class="modal-dialog">
        <form action="{{ url_for('suggest_edit', carrier_id=carrier.carrier_id) }}" method="POST">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">Suggest an Edit</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info small">
                        Help us maintain accuracy. Admin will review your changes.
                    </div>
                    
                    <!-- Lead Gen / Author Info -->
                    <div class="row g-2 mb-3">
                        <div class="col-md-6">
                            <label class="form-label small fw-bold">Your Name</label>
                            <input type="text" name="submitter_name" class="form-control form-control-sm" placeholder="Optional">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label small fw-bold">Your Email</label>
                            <input type="email" name="submitter_email" class="form-control form-control-sm" placeholder="Optional">
                        </div>
                    </div>
                    <hr>

                    <div class="mb-3">
                        <label class="form-label">Field to Update</label>
                        <select name="field_name" class="form-select" id="field-selector">
                            <option value="phone_claims">Claims Phone</option>
                            <option value="address_claims_street">Claims Address</option>
                            <option value="payer_id">Payer ID</option>
                            <option value="website_url">Website</option>
                        </select>
                    </div>

                    <input type="hidden" name="old_value" id="modal-old-val">

                    <div class="mb-3">
                        <label class="form-label">New Information</label>
                        <textarea name="new_value" class="form-control" rows="3" required></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-primary">Submit for Approval</button>
                </div>
            </div>
        </form>
    </div>
</div>
{% endblock %}